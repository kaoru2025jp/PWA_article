<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>PWA Article Contract</title>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
}
input, button {
  margin: 5px 0;
}
#article {
  white-space: pre-wrap;
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
  min-height: 120px;
}
canvas {
  border: 1px solid #000;
  margin-top: 10px;
  touch-action: none;
}
.disabled {
  opacity: 0.4;
  pointer-events: none;
}
</style>
</head>

<body>

<h2>条文検索</h2>

<input type="text" id="num" placeholder="1〜7 または 1234567">
<button onclick="fetchArticle()">取得</button>

<div id="article"></div>

<h3>署名</h3>
<canvas id="sign" width="400" height="150" class="disabled"></canvas>
<br>
<button onclick="clearSign()">署名クリア</button>

<script>
/* ===== 設定 ===== */
const GAS_URL = "ここにGASのWebApp URL";

/* ===== 状態管理 ===== */
const articles = {};
const loaded = new Set();

/* ===== 条文取得 ===== */
function fetchArticle() {
  const input = document.getElementById("num").value.trim();

  if (input === "1234567") {
    loadAllArticles();
    return;
  }

  const n = Number(input);
  if (n < 1 || n > 7) return;

  fetch(`${GAS_URL}?num=${n}`)
    .then(res => res.json())
    .then(data => {
      if (data.text) {
        articles[n] = data.text;
        loaded.add(n);
        document.getElementById("article").innerText = data.text;
      }
    });
}

/* ===== 全条文読み込み ===== */
function loadAllArticles() {
  let requests = [];
  for (let i = 1; i <= 7; i++) {
    requests.push(
      fetch(`${GAS_URL}?num=${i}`)
        .then(res => res.json())
        .then(data => articles[i] = data.text)
    );
  }

  Promise.all(requests).then(() => {
    showContract();
    enableSignature();
  });
}

/* ===== 契約書表示 ===== */
function showContract() {
  let text = "契約書\n\n";
  for (let i = 1; i <= 7; i++) {
    text += articles[i] + "\n\n";
  }
  document.getElementById("article").innerText = text;
}

/* ===== 署名ボード ===== */
const canvas = document.getElementById("sign");
const ctx = canvas.getContext("2d");
ctx.lineWidth = 2;
ctx.lineCap = "round";

let drawing = false;

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  if (e.touches) {
    return {
      x: e.touches[0].clientX - rect.left,
      y: e.touches[0].clientY - rect.top
    };
  }
  return { x: e.offsetX, y: e.offsetY };
}

function startDraw(e) {
  if (canvas.classList.contains("disabled")) return;
  drawing = true;
  const pos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}

function draw(e) {
  if (!drawing) return;
  e.preventDefault();
  const pos = getPos(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
}

function endDraw() {
  drawing = false;
}

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", endDraw);

canvas.addEventListener("touchstart", startDraw);
canvas.addEventListener("touchmove", draw);
canvas.addEventListener("touchend", endDraw);

function clearSign() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

/* ===== 署名有効化 ===== */
function enableSignature() {
  canvas.classList.remove("disabled");
}
</script>

</body>
</html>
